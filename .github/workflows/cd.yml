name: CD - Deploy to EC2 K3s + Cypress

on:
  push:
    branches:
      - ci-cd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ec2-3-89-254-174.compute-1.amazonaws.com >> ~/.ssh/known_hosts

      - name: SSH and deploy from current branch
        env:
          BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@ec2-3-89-254-174.compute-1.amazonaws.com << EOF
            set -e

            echo "📁 切換到專案資料夾"
            cd ~/Cloud-Native-final

            echo "🌐 取得最新程式碼（\$BRANCH）"
            git fetch origin
            git checkout \$BRANCH
            git pull origin \$BRANCH

            echo "🚀 部署前後端到 K3s"
            sudo k3s kubectl apply -f k8s/namespace.yaml
            sudo k3s kubectl apply -n cloudnative -f k8s/backend-deployment.yaml
            sudo k3s kubectl apply -n cloudnative -f k8s/backend-service.yaml
            sudo k3s kubectl apply -n cloudnative -f k8s/frontend-deployment.yaml
            sudo k3s kubectl apply -n cloudnative -f k8s/frontend-service.yaml

            echo "🧪 執行 Cypress 測試"
            cd test
            npm ci
            npx cypress run

            echo "✅ 完成部署與測試"
          EOF

# name: CD - Deploy to EC2 on Same Branch

# on:
#   workflow_run:
#     workflows: ["CI - Build & Push Images"]
#     types:
#       - completed

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     if: github.event.workflow_run.conclusion == 'success' &&
#       (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'test' || github.event.workflow_run.head_branch == 'ci-cd')

#     steps:
#       - name: Set up SSH
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
#           chmod 600 ~/.ssh/id_ed25519
#           ssh-keyscan -H 54.167.106.86 >> ~/.ssh/known_hosts

#       - name: SSH and deploy from correct branch
#         run: |
#           ssh -i ~/.ssh/id_ed25519 ubuntu@54.167.106.86 << 'EOF'
#             set -e
#             cd /home/ubuntu/my-app
#             git fetch origin
#             git checkout ${{ github.event.workflow_run.head_branch }}
#             git pull origin ${{ github.event.workflow_run.head_branch }}
#             echo "✅ Deployed branch: ${{ github.event.workflow_run.head_branch }}"
#           EOF

#       # - name: Install Cypress
#       #   run: |
#       #     cd test
#       #     npm ci

#       # - name: Run Cypress E2E
#       #   run: |
#       #     cd test
#       #     npx cypress run
